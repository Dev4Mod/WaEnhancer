- name: Post to Telegram channel
  if: ${{ success() && (github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch') && github.ref_type != 'tag' }}
  env:
    CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
    BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
    COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
    COMMIT_URL: ${{ github.event.head_commit.url }}
  run: |
    if [ -n "$BOT_TOKEN" ] && [ -n "$CHANNEL_ID" ]; then
      GITHUB_SHA_SHORT=$(git rev-parse --short HEAD)
      output_whatsapp="app/WaEnhancer_$GITHUB_SHA_SHORT.apk"
      output_business="app/WaEnhancer_Business_$GITHUB_SHA_SHORT.apk"
      cp app/build/outputs/apk/whatsapp/debug/app-whatsapp-debug.apk "$output_whatsapp"
      cp app/build/outputs/apk/business/debug/app-business-debug.apk "$output_business"
      LOG=$(cat changelog.txt)
      ESCAPED=$(python3 -c 'import json,os,urllib.parse; msg = json.dumps(os.getenv("LOG")); print(urllib.parse.quote(msg if len(msg) <= 1024 else json.dumps(os.getenv("COMMIT_URL"))))'
    
      # Send WhatsApp variant
      curl "https://api.telegram.org/bot${BOT_TOKEN}/sendMediaGroup?chat_id=${CHANNEL_ID}&media=%5B%7B%22type%22%3A%22document%22%2C%20%22media%22%3A%22attach%3A%2F%2Fwa%22%7D%2C%7B%22type%22%3A%22document%22%2C%20%22media%22%3A%22attach%3A%2F%2Fw4b%22%2C%22caption%22%3A${ESCAPED}%7D%5D" -F "wa=@$output_whatsapp" -F "w4b=@$output_business"
    fi
